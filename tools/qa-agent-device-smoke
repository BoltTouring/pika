#!/usr/bin/env bash
set -euo pipefail

# Deterministic mobile UI smoke using agent-device.
#
# Goal: open app, (create account if needed), start a chat with PEER, send "ping", wait for "pong".
#
# Usage:
#   tools/qa-agent-device-smoke --platform ios --peer npub1...
#   tools/qa-agent-device-smoke --platform android --peer npub1...
#   tools/qa-agent-device-smoke --platform both --peer npub1...
#
# Notes:
# - This is intentionally not "AI exploration". It uses stable identifiers on iOS and visible labels on Android.
# - The OpenClaw/Rust bot only guarantees ping->pong. Other prompts are expected to be ignored.

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT"

platform=""
peer="${PIKA_PEER_NPUB:-}"
message="${PIKA_SMOKE_MESSAGE:-ping}"
expect="${PIKA_SMOKE_EXPECT:-pong}"
timeout_ms="${PIKA_SMOKE_TIMEOUT_MS:-120000}"

usage() {
  cat <<EOF >&2
usage: tools/qa-agent-device-smoke --platform ios|android|both --peer <npub1...|hex64>

env:
  PIKA_SMOKE_MESSAGE=ping
  PIKA_SMOKE_EXPECT=pong
  PIKA_SMOKE_TIMEOUT_MS=120000
EOF
}

while [ "$#" -gt 0 ]; do
  case "$1" in
    --platform)
      platform="${2:-}"; shift 2 ;;
    --peer)
      peer="${2:-}"; shift 2 ;;
    --message)
      message="${2:-}"; shift 2 ;;
    --expect)
      expect="${2:-}"; shift 2 ;;
    -h|--help)
      usage; exit 0 ;;
    *)
      usage; exit 2 ;;
  esac
done

if [ -z "${platform:-}" ] || [ -z "${peer:-}" ]; then
  usage
  exit 2
fi

run_ios() {
  local session="qa-ios"
  echo "[smoke][ios] opening app"
  ./tools/agent-device --platform ios --session "$session" open com.pika.app >/dev/null

  dismiss_ios_modals() {
    # Dismiss common modal alerts that block the accessibility tree.
    set +e
    ./tools/agent-device --platform ios --session "$session" alert accept 5000 >/dev/null 2>&1
    ./tools/agent-device --platform ios --session "$session" find text OK click >/dev/null 2>&1
    set -e
  }
  dismiss_ios_modals

  # If we're on Login, create an account. If already logged in, this may fail; that's fine.
  set +e
  ./tools/agent-device --platform ios --session "$session" find id login_create_account click >/dev/null 2>&1
  set -e

  # We can land in one of:
  # - Chats list (toolbar has "New Chat" / logout)
  # - New Chat screen (peer field)
  # - A Chat screen (message composer)
  #
  # Avoid waiting on plain text "Chats" since that's also the back button label.
  echo "[smoke][ios] waiting for logged-in UI"
  end=$(( $(date +%s) + (timeout_ms/1000) ))
  while :; do
    dismiss_ios_modals
    set +e
    ./tools/agent-device --platform ios --session "$session" find id chat_message_input get attrs >/dev/null 2>&1
    has_chat="$?"
    ./tools/agent-device --platform ios --session "$session" find id newchat_peer_npub get attrs >/dev/null 2>&1
    has_newchat="$?"
    ./tools/agent-device --platform ios --session "$session" find id chatlist_new_chat get attrs >/dev/null 2>&1
    has_chatlist="$?"
    set -e
    if [ "$has_chat" -eq 0 ] || [ "$has_newchat" -eq 0 ] || [ "$has_chatlist" -eq 0 ]; then
      break
    fi
    if [ "$(date +%s)" -ge "$end" ]; then
      echo "[smoke][ios] error: timed out waiting for chat UI" >&2
      return 1
    fi
    sleep 0.5
  done

  # If not already in a chat, create/open one.
  set +e
  ./tools/agent-device --platform ios --session "$session" find id chat_message_input get attrs >/dev/null 2>&1
  in_chat="$?"
  set -e
  if [ "$in_chat" -ne 0 ]; then
    echo "[smoke][ios] navigating to New Chat"
    # If we're on chat list, tap the new chat toolbar button.
    set +e
    ./tools/agent-device --platform ios --session "$session" find id chatlist_new_chat click >/dev/null 2>&1
    ok="$?"
    set -e
    if [ "$ok" -ne 0 ]; then
      # Otherwise, try to go back until we can see the chat list toolbar.
      for _ in $(seq 1 6); do
        set +e
        ./tools/agent-device --platform ios --session "$session" find id chatlist_new_chat click >/dev/null 2>&1
        ok="$?"
        set -e
        if [ "$ok" -eq 0 ]; then break; fi
        ./tools/agent-device --platform ios --session "$session" back >/dev/null 2>&1 || true
        dismiss_ios_modals
        sleep 0.4
      done
    fi

    echo "[smoke][ios] peer -> start"
    ./tools/agent-device --platform ios --session "$session" find id newchat_peer_npub fill "$peer" >/dev/null
    ./tools/agent-device --platform ios --session "$session" find id newchat_start click >/dev/null
  fi

  echo "[smoke][ios] send message and wait for reply"
  # Ensure any "Creating chat..." modal is dismissed before trying to focus the composer.
  dismiss_ios_modals

  # Prefer fill-by-id, but fall back to clicking the "Message" placeholder then typing.
  set +e
  ./tools/agent-device --platform ios --session "$session" find id chat_message_input fill "$message" >/dev/null 2>&1
  ok="$?"
  set -e
  if [ "$ok" -ne 0 ]; then
    ./tools/agent-device --platform ios --session "$session" find text Message click >/dev/null
    ./tools/agent-device --platform ios --session "$session" type "$message" >/dev/null
  fi
  ./tools/agent-device --platform ios --session "$session" find id chat_send click >/dev/null
  ./tools/agent-device --platform ios --session "$session" wait text "$expect" "$timeout_ms" >/dev/null

  echo "[smoke][ios] ok"
}

run_android() {
  local session="qa-android"
  echo "[smoke][android] opening app"
  ./tools/agent-device --platform android --session "$session" open com.pika.app >/dev/null

  # Create account if visible.
  set +e
  ./tools/agent-device --platform android --session "$session" find text "Create Account" click >/dev/null 2>&1
  set -e

  echo "[smoke][android] waiting for Chats"
  ./tools/agent-device --platform android --session "$session" wait text Chats "$timeout_ms" >/dev/null

  echo "[smoke][android] new chat -> peer -> start"
  set +e
  ./tools/agent-device --platform android --session "$session" find label "New Chat" click >/dev/null 2>&1
  if [ "$?" -ne 0 ]; then
    ./tools/agent-device --platform android --session "$session" find text "New Chat" click >/dev/null 2>&1
  fi
  set -e

  ./tools/agent-device --platform android --session "$session" find text "Peer npub" fill "$peer" >/dev/null
  ./tools/agent-device --platform android --session "$session" find text "Start chat" click >/dev/null

  echo "[smoke][android] send message and wait for reply"
  ./tools/agent-device --platform android --session "$session" find text "Message" fill "$message" >/dev/null
  ./tools/agent-device --platform android --session "$session" find text "Send" click >/dev/null
  ./tools/agent-device --platform android --session "$session" wait text "$expect" "$timeout_ms" >/dev/null

  echo "[smoke][android] ok"
}

case "$platform" in
  ios) run_ios ;;
  android) run_android ;;
  both)
    run_ios
    run_android
    ;;
  *)
    usage; exit 2 ;;
esac
